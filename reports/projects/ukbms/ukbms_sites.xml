<?xml version="1.0" encoding="UTF-8"?>
<report title="UKBMS sampling locations" description="Todo description">
  <query>
    SELECT * FROM
      (SELECT
      l.id as id,
      l.name as name,
      t.term as type,
      l.location_type_id as ltype,
      l.code as lcode,
      l.centroid_sref as centroid_sref,
      COUNT(DISTINCT sp.id) as samples,
      COUNT(DISTINCT extract(YEAR from sp.date_start)) as n_year,
      min(extract(YEAR from sp.date_start)) first_year,
      max(extract(YEAR from sp.date_start)) last_year,
      l.code as code,
      st_x(st_centroid(st_transform(l.centroid_geom, 4326))) as lon,
      st_y(st_centroid(st_transform(l.centroid_geom, 4326))) as lat
      FROM locations l
      JOIN locations_websites lw ON l.id=lw.location_id AND lw.deleted=false
      left JOIN samples sp ON sp.location_id=l.id
      join termlists_terms tt on l.location_type_id = tt.id
      join terms t on tt.term_id = t.id
      WHERE l.deleted=false
        AND l.location_type_id in (777, 5195, 5196)
        AND lw.website_id=27
      group by l.id, t.term
      order by samples asc, name) as subsel
    where ltype=777 or samples>0
  </query>
  <columns>
    <column name="lat" display="Lat" visible="false"/>
    <column name="lon" display="Lon" visible="false"/>
    <column name="name" display="Site" />
    <column name="lcode" display="UKBMS code" />
    <column name="id" display="Site ID" />
    <column name="type" display="Survey type" />
    <column name="first_year" display="First year surveyed" />
    <column name="last_year" display="Last year surveyed" />
    <column name="n_year" display="Number of years surveyed" />
    <column name="samples" display="Number of surveys" />
    <column name="centroid_sref" display="Grid reference" />
  </columns>
</report>