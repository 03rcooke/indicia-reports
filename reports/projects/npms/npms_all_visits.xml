<report
    title="NPMS All Visits"
    description="Display a list of visits suitable for adminstrators to view all data."
>
  <query website_filter_field="csf.website_id">
    SELECT #columns# 
      FROM cache_samples_functional csf
      JOIN cache_samples_nonfunctional csnf on csnf.id = csf.id
      JOIN users u on u.id=csf.created_by_id AND u.deleted=false
      JOIN people p on p.id=u.person_id AND p.deleted=false
      JOIN locations plot ON plot.id = csf.location_id AND plot.deleted=false
      JOIN cache_termlists_terms cache_ttPlotType on cache_ttPlotType.id = plot.location_type_id
      JOIN locations square ON square.id = plot.parent_id AND square.deleted=false
      LEFT JOIN location_attribute_values lavPlotName on lavPlotName.location_attribute_id=#plot_number_attr_id# AND lavPlotName.location_id=plot.id AND lavPlotName.deleted=false
      --JOIN sample_attribute_values savLinkToSurveyOne ON savLinkToSurveyOne.sample_id = csf.id AND savLinkToSurveyOne.sample_attribute_id = #s1AttrID# AND savLinkToSurveyOne.int_value = 0
      LEFT JOIN sample_attribute_values savLinkToSurveyOne ON savLinkToSurveyOne.sample_id = csf.id AND savLinkToSurveyOne.sample_attribute_id = #s1AttrID# 
          AND savLinkToSurveyOne.int_value != 0 AND savLinkToSurveyOne.deleted=false
      WHERE 
      #website_filter#
      AND (trim('#date_from#')='' OR '#date_from#'='Click here' OR csf.date_end &gt;= CAST(COALESCE('#date_from#','1500-01-01') as date))
      AND (trim('#date_to#')='' OR '#date_to#'='Click here' OR csf.date_start &lt;= CAST(COALESCE('#date_to#','1500-01-01') as date)) 
      AND csf.survey_id != #extra_species_survey_id#
      #order_by#
  </query>
  <order_bys>
    <order_by>csf.id DESC</order_by>
  </order_bys>
    <params>
    <param name = 's1AttrID' display = 'Sample 1 Attribute ID' description = 'The ID of the sample attribute that links a second sample to a first' datatype = 'int' />
    <param name = 'plot_number_attr_id' display = 'Plot number attribute Id' description = 'Id of the location attribute that holds the plot number label' datatype = 'int' default = '0' empytvalue = '0'/>
    <param name = 'date_from' display = 'Date From' datatype = 'date' />
    <param name = 'date_to' display = 'Date To' datatype = 'date' />
    s<param name = 'extra_species_survey_id' display = 'Extra Species Survey ID' description = 'Survey ID of the Extra Species survey' datatype = 'integer' />
  </params>
  <columns>
    <column name='survey' display='Survey' sql='csnf.survey_title' datatype='text'/>
    <column name='sample_1_id' sql="coalesce(savLinkToSurveyOne.int_value,csf.id)" display='Public Visit ID' datatype="integer"/>
    <column name='id' display='Actual Database Sample ID' sql='csf.id' datatype='integer' in_count="true"/>
    <column name='square_name' sql="square.centroid_sref" display='Square'/>
    <column name='plot_name'
    sql="
    COALESCE(
        case 
        when lavPlotName.text_value IS null 
          then '&lt;i&gt;' || 'Plot at ' || plot.centroid_sref || ' ('||  cache_ttPlotType.term || ') ' || '&lt;/i&gt;' 
        else 
          '&lt;i&gt;' || 'Plot ' || lavPlotName.text_value || ' at ' || plot.centroid_sref || ' ('||  cache_ttPlotType.term || ') ' || '&lt;/i&gt;' 
        end
        , csf.location_name, csnf.public_entered_sref)
    " display='Plot' />
    <column name='date_start' sql='csf.date_start' visible="false"/>
    <column name='date_end' sql='csf.date_end' visible="false"/>
    <column name='date_type' sql='csf.date_type' visible="false"/>
    <column name='date' display='Date' datatype="date"/>
    <column name='first_name' display='First Name' datatype='text' sql='p.first_name'/>
    <column name='surname' display='Surname' datatype='text' sql='p.surname'/>
    <column name='email_address' display='Email' datatype='text' sql='p.email_address'/>
    <column name='survey_number' sql="
    case when (savLinkToSurveyOne.int_value IS NOT NULL AND savLinkToSurveyOne.int_value != 0) THEN 'Survey 2' 
    when (savLinkToSurveyOne.int_value IS NULL OR savLinkToSurveyOne.int_value = 0) THEN 'Survey 1'
    ELSE  '' END" display=' '/>
    <column name='input_form' visible="false" sql="case when csf.input_form is null then '#default_input_form#' else csf.input_form end" />
  </columns>
</report>