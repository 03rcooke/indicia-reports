<report
    title="PoMS results in detail"
    description="PomS results in detail. Includes full detail location data"
>
  <query website_filter_field="" training_filter_field="" >
    SELECT #columns# 
      FROM samples s
      JOIN indicia.cache_samples_nonfunctional csnf on csnf.id = s.id
      LEFT JOIN sample_attribute_values hab_sav on hab_sav.sample_id = s.id AND hab_sav.sample_attribute_id = #habitat_smp_id# 
          AND hab_sav.deleted = false
      LEFT JOIN cache_termlists_terms hab_term on hab_term.id = hab_sav.int_value
      LEFT JOIN sample_attribute_values target_sav on target_sav.sample_id = s.id AND target_sav.sample_attribute_id = #target_smp_id# 
          AND target_sav.deleted = false
      LEFT JOIN cache_termlists_terms target_term on target_term.id = target_sav.int_value
      LEFT JOIN sample_attribute_values trap_station_sav on trap_station_sav.sample_id = s.id AND trap_station_sav.sample_attribute_id = #trap_station_smp_id# 
          AND trap_station_sav.deleted = false
      LEFT JOIN cache_termlists_terms trap_station_term on trap_station_term.id = trap_station_sav.int_value
      LEFT JOIN sample_attribute_values start_time_sav on start_time_sav.sample_id = s.id AND start_time_sav.sample_attribute_id = #start_time_smp_id# 
          AND start_time_sav.deleted = false
      LEFT JOIN cache_occurrences_functional cof on cof.sample_id = s.id
      LEFT JOIN occurrence_attribute_values oav on oav.occurrence_id = cof.id 
        AND occurrence_attribute_id = #insect_abund_occ_id# AND oav.deleted = false
      #agreements_join#
      WHERE #sharing_filter# 
        AND s.survey_id in (
          #public_fit_count_survey_id#,#1km_fit_count_survey_id#,#1km_pan_traps_survey_id#,#fit_count_app_survey_id#
        )
        AND ((trim('#year#') = '' OR '#year#'='Click here' OR s.date_end &gt;= CAST('#year#' || '-01-01' as date))
            AND (trim('#year#')  = '' OR '#year#'='Click here' OR s.date_start &lt;= CAST('#year#' || '-12-31' as date)))
        AND (CAST(s.survey_id AS character varying) = '#survey_id#' OR '#survey_id#'='')
  </query>
  <params>
    <param name = "current_user_id" display="Current User ID" description="Current user's warehouse ID. Allows a column to be output indicating that the user owns the record." datatype="text" />
    <param name = "habitat_smp_id" display="Habitat sample attribute ID" description = "ID of sample attribute that holds the habitat." datatype="integer"/>
    <param name = "target_smp_id" display="Target flower sample attribute ID" description = "ID of sample attribute that holds the target flower." datatype="integer"/>  
    <param name = "trap_station_smp_id" display="Trap station sample attribute ID" description = "ID of sample attribute that holds the pan trap station number." datatype="integer"/>  
    <param name = "start_time_smp_id" display="Start time sample attribute ID" description = "ID of sample attribute that holds the FIT count start time." datatype="integer"/>  
    <param name = "insect_abund_occ_id" display="Insect abundance occurrence attribute ID" 
      description = "ID of occurrence attribute that holds abundances of the insects." datatype="integer"/>  
    <param name = 'year_termlist_id' display='NPMS years termlist ID' datatype="int"/>
    <param name = 'year' display='Year' description='Select a year, or leave blank for all years'
      population_call='direct:termlists_term:term:term:termlist_id=#year_termlist_id#' datatype="lookup"/>
    <param name = "public_fit_count_survey_id" display="Public fit count survey ID" description = "ID of the public fit count survey." datatype="integer"/>  
    <param name = "1km_fit_count_survey_id" display="1km fit count survey ID" description = "ID of the 1km fit count survey." datatype="integer"/>  
    <param name = "1km_pan_traps_survey_id" display="1km pan traps survey ID" description = "ID of the 1km pan traps survey." datatype="integer"/>  
    <param name = "fit_count_app_survey_id" display="Fit count app survey ID" description = "ID of the fit count app survey." datatype="integer"/>  
    <param name = 'survey_id' display='Survey' description='Select the survey to return data for' datatype='lookup'
      lookup_values='636:FIT Count,637:FIT Count 1km,638:1km pan traps,641:FIT Count App' />
    <param name="ownData" display="My data only?" datatype="checkbox">
      <where value="1">s.created_by_id=#current_user_id#</where>
    </param>
  </params>
  <columns>
    <column name='id' sql='s.id' display='ID' in_count="true" datatype="integer"/>
    <column name='survey_id' sql='s.survey_id' display='Survey ID' visible="false" datatype="integer"/>
    <column name='survey_title' sql="
      case s.survey_id
        when #public_fit_count_survey_id# then 'FIT Count'
        when #1km_fit_count_survey_id# then 'FIT Count 1km'
        when #1km_pan_traps_survey_id# then '1km pan traps'
        when #fit_count_app_survey_id# then 'FIT Count App'
        else ''
        END" display='Survey' datatype="integer"/>
    <column name='date_start' sql='s.date_start' visible="false"/>
    <column name='date_end' sql='s.date_end' visible="false"/>
    <column name='date_type' sql='s.date_type' visible="false"/>
    <column name='date' display='Date' datatype="date"/>
    <column name='grid_ref' display='Grid ref' sql='s.entered_sref' datatype="text"/>
    <column name='habitat' display='Habitat' sql='hab_term.term' datatype="text"/>
    <column name='target' display='Target flower' sql='target_term.term' datatype="text"/>
    <column name='target_photo' display='Photo of target flower' sql='csnf.media' img='true' />
    <column name='number_insects' display='Total number of insects' sql='sum(oav.int_value)' aggregate="true" datatype="integer"/>
    <column name='start_time' display='Start time' sql='start_time_sav.text_value'/>
    <column name='pan_trap_number' display='Pan-trap number' sql='trap_station_term.term'/>
    <column name='recorder_names' display='Recorder names' sql='csnf.recorders'/>
    <column name='show_public_fit_count_edit_icon' display='Show public fit count edit icon' 
        sql="CASE WHEN 
            (CAST(s.survey_id AS character varying) = '#public_fit_count_survey_id#' OR
            CAST(s.survey_id AS character varying) = '#fit_count_app_survey_id#') 
            THEN true ELSE false END" visible="false" />
    <column name='show_1km_fit_count_edit_icon' display='Show 1km fit count edit icon' 
        sql="CASE WHEN CAST(s.survey_id AS character varying) = '#1km_fit_count_survey_id#' THEN true ELSE false END" visible="false" />
    <column name='show_1km_pan_traps_edit_icon' display='Show 1km pan-traps edit icon' 
        sql="CASE WHEN CAST(s.survey_id AS character varying) = '#1km_pan_traps_survey_id#' THEN true ELSE false END" visible="false" />
  </columns>
</report>
