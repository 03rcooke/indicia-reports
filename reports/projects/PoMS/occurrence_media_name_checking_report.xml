<report
    title="Occurrence media name checking report"
    description="Report allows experts to provide a corrected name of a (user entered) occurrence media item."
>
  <query website_filter_field="" training_filter_field="cof.training" >
    SELECT #columns# 
      FROM indicia.cache_occurrences_functional cof
      JOIN indicia.cache_occurrences_nonfunctional conf on conf.id = cof.id

      JOIN cache_taxa_taxon_lists cttl_entered_species on cttl_entered_species.id = cof.taxa_taxon_list_id

      LEFT JOIN occurrence_attribute_values oav_correction on oav_correction.occurrence_id = cof.id 
          AND oav_correction.occurrence_attribute_id = #correction_occ_attr_id#
          AND oav_correction.deleted = false  
      LEFT JOIN cache_taxa_taxon_lists cttl_correction on cttl_correction.id = oav_correction.int_value

      WHERE #sharing_filter# 
        AND cof.survey_id in (#survey_ids#)
  </query>
  <order_bys>
    <order_by>cof.id DESC</order_by>
  </order_bys>
  <params>
    <param name="correction_occ_attr_id" display="Corrected flower occurrence attribute ID" 
        description="occurrence attribute ID that holds the corrected flower entered by an expert" datatype="integer"/>
    <param name = "survey_ids" display="Survey IDs" description = "Comma separated list of Survey IDs to limit report to." datatype="text"/>
  </params>
  <columns>
    <column name='id' display='Occurrence ID' datatype="integer" sql="cof.id" />
    <column name='correction_oav_id' display='Correction occurrence_attribute_value_id' datatype="text" sql="oav_correction.id" visible = "false" />
    <column name='entered_species_name' display='Entered species name' datatype="text" sql="cttl_entered_species.taxon" />
    <column name='corrected_species_name_id' display='Correction' datatype="text" sql="cttl_correction.taxon || '-' || oav_correction.id" />
    <column name='images' display='Images' sql='conf.media' img='true' />
  </columns>
</report>
